load_module /usr/lib64/nginx/modules/ngx_stream_module.so;
worker_processes auto;

error_log /var/log/nginx/error.log info;

events {
    worker_connections  1024;
}

stream {
{{range $farmKey,$farmValue := .}}
{{ range $idx,$server := $farmValue.Servers }}

    upstream {{$farmValue.FarmName}}-{{$server.Bind}}-{{$server.Port}} {
        {{ range $backendIdx,$backend := $server.Discovery.BackendSpec }}    server {{ $backend.Host }}:{{ $backend.Port }};
{{end}}
    }

    server {
        listen {{$server.Bind}}:{{$server.Port}} udp;
        proxy_connect_timeout 1s;
        proxy_timeout 3s;
        proxy_pass {{$farmValue.FarmName}}-{{$server.Bind}}-{{$server.Port}};
    }
{{end}}
{{end}}
}